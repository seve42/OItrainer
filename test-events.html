<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>事件测试（临时） - 用完即删</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body{padding:18px;font-family:Segoe UI, Roboto, "Helvetica Neue", Arial}
    .panel{max-width:900px;margin:0 auto}
    .btn{padding:8px 12px;border-radius:6px;border:1px solid #2b6cb0;background:#eaf4ff;cursor:pointer}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    #event-cards-container{margin-top:12px}
    .hint{color:#666;margin-top:8px}
  </style>
<!-- Clarity tracking removed -->
</head>
<body>
  <div class="panel">
    <h2>事件测试页面（临时）</h2>
    <p class="hint">说明：本页面包含用于触发项目中所有事件的测试代码，仅用于开发测试，用完请删除此文件。</p>

    <div class="row">
      <button id="btn-trigger-all" class="btn">触发所有事件</button>
      <button id="btn-force-webproject" class="btn">强制触发：课余项目</button>
      <button id="btn-trigger-poaching" class="btn">测试：触发跨省挖人事件</button>
      <button id="btn-trigger-random" class="btn">运行 EventManager.checkRandomEvents()</button>
      <button id="btn-clear-events" class="btn">清空事件卡片</button>
      <button id="btn-reset-game" class="btn">重置游戏（尝试）</button>
    </div>

    <div id="outputs" style="margin-top:12px"></div>

    <h3 style="margin-top:18px">事件卡片预览</h3>
    <div id="event-cards-container"></div>

    <script src="events.js"></script>
    <script src="lib/constants.js"></script>
    <script src="lib/utils.js"></script>
    <script src="lib/models.js"></script>
    <script src="lib/talent.js"></script>
    <script src="lib/competitions.js"></script>
    <script src="lib/contest-ui.js"></script>
    <script src="lib/contest-integration.js"></script>
    <script src="game.js"></script>
<script src="render.js"></script>
<script src="debug.js"></script>

    <script>
      // Test helper: build a minimal game state if not already present
      function ensureGame(){
        if(window.game) return window.game;
        try{ window.game = new GameState(); }catch(e){
          // minimal fallback
          window.game = { week:1, budget:50000, reputation:50, students: [ {name:'张三', active:true, pressure:10, thinking:40, coding:40, comfort:80}, {name:'李四', active:true, pressure:20, thinking:50, coding:50, comfort:80} ], province_name: '广东', temperature: 25 };
        }
        return window.game;
      }

      function appendOut(txt){ const d = document.createElement('div'); d.innerText = txt; document.getElementById('outputs').prepend(d); }

      document.getElementById('btn-clear-events').addEventListener('click', ()=>{ recentEvents.splice(0); renderEventCards(); appendOut('已清空事件卡片'); });

      <!-- 已移除：测试选择事件（用于开发验证）的按钮与处理逻辑 -->

      document.getElementById('btn-reset-game').addEventListener('click', ()=>{ try{ 
          try{ console.debug('Test page reset: will remove oi_coach_save, exists:', (localStorage.getItem('oi_coach_save') !== null)); }catch(e){}
          localStorage.removeItem('oi_coach_save'); location.reload(); 
        }catch(e){ appendOut('重置失败: '+e.message); } });

      document.getElementById('btn-trigger-random').addEventListener('click', ()=>{
        ensureGame();
        if(window.EventManager && typeof window.EventManager.checkRandomEvents === 'function'){
          try{ window.EventManager.checkRandomEvents(window.game); appendOut('已运行 EventManager.checkRandomEvents()'); renderAll(); }catch(e){ appendOut('运行失败: '+e.message); }
        } else appendOut('EventManager 未找到');
      });

      // 新增：专用测试按钮 - 构造满足条件的 careerCompetitions 并触发 poaching_offer
      document.getElementById('btn-trigger-poaching').addEventListener('click', ()=>{
        const g = ensureGame();
        // 确保有一名学生
        if(!Array.isArray(g.students) || g.students.length === 0){ g.students = [{ name: '测试生', active: true, thinking: 90, coding: 90, mental: 80, pressure: 20, comfort: 80 }]; }
        const target = g.students[0];
        // 设置当前周
        g.week = g.week || 1;
        // 构造 careerCompetitions 记录：NOIP 满分触发
        if(!g.careerCompetitions) g.careerCompetitions = [];
        // remove old test records with same name to avoid duplicate
        g.careerCompetitions = g.careerCompetitions.filter(r => !(r.entries && r.entries.some(e=>e.name === target.name && (r.name === 'NOIP' || r.name === '省选'))));
        // push a NOIP full-score record
        g.careerCompetitions.push({ week: g.week, name: 'NOIP', passedCount: 1, totalStudents: 1, entries: [{ name: target.name, score: 400 }] });
        appendOut(`已插入测试比赛记录：${target.name} 在 NOIP 得到满分 400（周 ${g.week}）`);

        // Ensure EventManager has been initialized with registerDefaultEvents earlier in script.js; now trigger checks
        try{
          if(window.EventManager && typeof window.EventManager.checkRandomEvents === 'function'){
            window.EventManager.checkRandomEvents(g);
            appendOut('已调用 EventManager.checkRandomEvents(window.game)');
          } else {
            appendOut('EventManager 未就绪：无法运行 checkRandomEvents');
          }
        }catch(e){ appendOut('运行 EventManager 失败: ' + e.message); }
      });

      document.getElementById('btn-trigger-all').addEventListener('click', ()=>{
        const g = ensureGame();
        // Prepare ctx similar to registerDefaultEvents
        const ctx = { game: g, PROVINCES: window.PROVINCES, constants: window, utils: window, log: console.log };
        if(!window.EventManager || !window.EventManager._events) return appendOut('EventManager 或事件列表未加载');

        // For events that cache per-student rolls in check(), we must call check(ctx) first
        window.EventManager._events.forEach(evt => {
          try{
            appendOut(`检查事件: ${evt.id} (${evt.name || ''})`);
            const shouldRun = (typeof evt.check === 'function') ? !!evt.check(ctx) : false;
            appendOut(`  check => ${shouldRun}`);
            const res = shouldRun && typeof evt.run === 'function' ? evt.run(ctx) : null;
            appendOut(`  run 返回: ${String(res)}`);
          }catch(e){ appendOut(`  执行失败: ${e.message}`); }
        });
        try{ renderAll(); }catch(e){}
        try{ renderEventCards(); }catch(e){}
      });

      // Force-trigger helper: trigger web_game_project for first active student
      document.getElementById('btn-force-webproject').addEventListener('click', ()=>{
        const g = ensureGame();
        const ctx = { game: g, PROVINCES: window.PROVINCES, constants: window, utils: window, log: console.log };
        if(!window.EventManager || !window.EventManager._events) return appendOut('EventManager 未加载');
        const evt = window.EventManager._events.find(e=>e.id === 'web_game_project');
        if(!evt) return appendOut('未找到 web_game_project 事件');
        // force a single student as triggered
        const active = (g.students || []).filter(s=>s && s.active !== false);
        if(active.length === 0) return appendOut('没有可用学生');
        evt._pendingTriggered = [ active[0] ];
        appendOut('已设置 pendingTriggered，调用 run');
        try{
          const res = evt.run && evt.run(ctx);
          appendOut('run 返回: ' + String(res));
          try{ renderAll(); }catch(e){}
        }catch(e){ appendOut('执行失败: ' + e.message); }
      });

      // Expose convenience
      window.appendOut = appendOut;
    </script>
  </div>
</body>
</html>