<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>开始 — OI 教练模拟器</title>
  <link rel="stylesheet" href="styles.css">
<script type="text/javascript">
  (function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
  })(window, document, "clarity", "script", "tpe6xsi392");
</script>
</head>
<body>
<div class="container">
  <header>
    <h1>OI 教练模拟器 — 开始</h1>
  </header>
  <div class="panel">
    <h3>新游戏设置</h3>
    
    <label class="block">选择难度</label>
    <select id="start-diff">
      <option value="1">简单 - 适合认为普通模式过难的人或初次游玩的人</option>
      <option value="2" selected>普通 - 标准游戏体验</option>
      <option value="3">困难 - 适合寻求挑战的人</option>
    </select>

    <label class="block" style="margin-top:10px">选择省份</label>
    <div class="small muted" style="margin-bottom:6px">不同省份影响初始经费和训练质量。<strong>强省</strong>资源丰富但期望更高，<strong>弱省</strong>起步较难但更有成就感。</div>
    <div id="start-prov-grid" class="prov-grid"></div>

    <label class="block" style="margin-top:10px">学生人数 (3-10)</label>
    <div class="small muted" style="margin-bottom:6px">更多学生意味着更多机遇，也会带来更多的经费开支</div>
    <input id="start-stu" type="number" min="3" max="10" value="5" />

    <!-- 原招生/学前培养 UI 已移除。下面仅展示可用天赋列表 -->
    <div class="sub-panel collapsible collapsed" id="talent-only-panel" style="margin-top:12px">
      <h4>游戏核心概念</h4>
      <div class="small muted" style="line-height:1.6;margin-bottom:10px">
        <p><strong>目标</strong>：带领学生在两个赛季内冲击NOI金牌，入选国家集训队，进军IOI</p>
        <p><strong>学生属性</strong>：思维、编程、心理三项基础能力 + 五大知识点（数据结构、图论、字符串、数学、DP）</p>
        <p><strong>经费管理</strong>：升级设施、参加集训都需要经费，需合理规划</p>
        <p><strong>压力系统</strong>：高压训练会增加压力，压力过高可能导致退队</p>
        <p><strong>比赛链</strong>：CSP-S1 → CSP-S2 → NOIP → 省选 → NOI，必须通过前一场才能参加下一场</p>
      </div>
  <h4 class="collapsible-head" style="margin-top:16px">天赋预览</h4>
  <div class="small muted" style="margin-bottom:6px">学生在训练中有概率获得天赋，天赋会影响比赛表现和训练效果</div>
      <div id="talent-grid" class="talent-grid"></div>
      <!-- 保留隐藏 select 以便与旧逻辑兼容（仅用于存储/表单同步） -->
      <select id="train-talent" style="display:none"></select>
    </div>

    <div class="modal-actions" style="margin-top:12px">
      <button class="btn btn-ghost" id="start-help">查看详细帮助</button>
      <button class="btn" id="daily-challenge-btn" style="background:#667eea;color:white;">📅 今日挑战</button>
      <button class="btn" id="start-button">开始游戏 🚀</button>
    </div>
  </div>
</div>

<script src="events.js"></script>
<script src="lib/constants.js"></script>
<script src="lib/utils.js"></script>
<script src="lib/models.js"></script>
<script src="lib/talent.js"></script>
<script src="script.js"></script>
<script>

  // 移除对招生/学前培养状态的维护；仅提供渲染天赋网格的功能
  function renderTalentGrid(){
    const grid = document.getElementById('talent-grid');
    const hiddenSelect = document.getElementById('train-talent');
    if(!grid || !hiddenSelect) return;
    grid.innerHTML = '';
    hiddenSelect.innerHTML = '';
    if(typeof window === 'undefined' || !window.TalentManager) return;
    const talents = window.TalentManager.getRegistered();
    talents.forEach(name => {
      const info = window.TalentManager.getTalentInfo(name) || {};
      // populate hidden select
      const opt = document.createElement('option'); opt.value = name; opt.textContent = name; hiddenSelect.appendChild(opt);

      // create card
      const card = document.createElement('div'); card.className = 'talent-card'; card.dataset.val = name;
      const top = document.createElement('div');
      const dot = document.createElement('span'); dot.className = 'color-dot'; dot.style.background = (info.color || '#2b6cb0');
      const title = document.createElement('span'); title.className = 'title'; title.textContent = name;
      top.appendChild(dot); top.appendChild(title);
      const desc = document.createElement('div'); desc.className = 'desc'; desc.textContent = info.description || '';
      card.appendChild(top); card.appendChild(desc);

      card.addEventListener('click', ()=>{
        // 单选高亮，仅用于展示/选择
        grid.querySelectorAll('.talent-card.selected').forEach(c=>c.classList.remove('selected'));
        card.classList.add('selected');
        hiddenSelect.value = name;
      });

      grid.appendChild(card);
    });
  }

  // 页面加载后渲染天赋列表：优先在 TalentManager 已注册天赋时立即渲染，
  // 否则在 window.load 后再渲染，并提供短轮询作为回退，确保在 registerDefaultTalents 之后渲染。
  function ensureRenderTalentGrid(){
    try{
      if(typeof window !== 'undefined' && window.TalentManager && typeof window.TalentManager.getRegistered === 'function'){
        const reg = window.TalentManager.getRegistered() || [];
        if(reg.length > 0){ renderTalentGrid(); return true; }
      }
    }catch(e){}
    return false;
  }

  if(!ensureRenderTalentGrid()){
    // 在 load 事件后再尝试（script.js 在 window.onload 中会调用 registerDefaultTalents）
    window.addEventListener('load', ()=>{ setTimeout(()=>{ renderTalentGrid(); }, 50); });

    // 作为额外保险，短轮询直到 TalentManager 出现或超时
    let _tg_tries = 0;
    const _tg_interval = setInterval(()=>{
      _tg_tries += 1;
      if(ensureRenderTalentGrid() || _tg_tries > 12) clearInterval(_tg_interval);
    }, 200);
  }

  // render province buttons using PROVINCES from script.js (保留页面其他功能的兼容性)
  if(typeof renderStartPageUI !== 'undefined'){
    renderStartPageUI && renderStartPageUI();
    setTimeout(() => {
      // 保留帮助与开始按钮行为
      document.getElementById('start-help').onclick = ()=>{ window.open('help.html','_blank'); };
      document.getElementById('start-button').onclick = ()=>{ startFromStartPage && startFromStartPage(); };
      
      // 今日挑战按钮
      document.getElementById('daily-challenge-btn').onclick = ()=>{ 
        if(typeof getDailyChallengeParams === 'function'){
          const params = getDailyChallengeParams();
          // 显示今日挑战信息
          const provinceName = (typeof PROVINCES !== 'undefined' && PROVINCES[params.provinceId]) 
            ? PROVINCES[params.provinceId].name 
            : '未知省份';
          
          if(confirm(`📅 今日挑战（${params.displayDate}）\n\n省份：${provinceName}\n难度：普通\n种子：${params.seed}\n\n所有玩家今天都将使用相同的初始条件！\n\n确认开始今日挑战？`)){
            // 设置今日挑战标记
            try {
              sessionStorage.setItem('oi_game_active_session', 'true');
              sessionStorage.setItem('oi_daily_challenge', 'true');
              sessionStorage.setItem('oi_daily_challenge_date', params.date);
            } catch(e) {
              console.error('无法设置 sessionStorage:', e);
            }
            
            // 跳转到游戏页面，带上今日挑战参数
            const url = `game.html?new=1&daily=1&d=${params.difficulty}&p=${params.provinceId}&c=5&seed=${params.seed}`;
            window.location.href = url;
          }
        } else {
          alert('今日挑战功能加载失败，请刷新页面重试');
        }
      };
    }, 100);
  }

    // 初始化可折叠面板：默认折叠对点招生与学前培养，点击标题切换
  (function(){
    function togglePanel(panel, expand){
      if(expand){
        panel.classList.remove('collapsed');
        panel.classList.add('expanded');
      } else {
        panel.classList.remove('expanded');
        panel.classList.add('collapsed');
      }
    }

    document.querySelectorAll('.sub-panel.collapsible').forEach(panel => {
      const head = panel.querySelector('.collapsible-head');
      // ensure initial state: keep collapsed if class present
      if(panel.classList.contains('collapsed')){
        togglePanel(panel, false);
      } else {
        togglePanel(panel, true);
      }

      head && head.addEventListener('click', ()=>{
        const isCollapsed = panel.classList.contains('collapsed');
        togglePanel(panel, isCollapsed);

        // 如果展开，尝试渲染面板内的延迟内容（例如天赋网格）
        try{
          if(!isCollapsed){
            // 如果面板包含天赋网格，则渲染
            if(panel.querySelector && panel.querySelector('#talent-grid')){
              if(typeof renderTalentGrid === 'function') renderTalentGrid();
            }
            // 兼容旧的 train-panel 行为
            if(panel.id === 'train-panel'){
              if(typeof populateTalentSelect === 'function') try{ populateTalentSelect(); }catch(e){}
            }
          }
        }catch(e){}
      });
    });
  })();
</script>
  <footer style="text-align:center;padding:12px 8px;color:#666;font-size:13px;border-top:1px solid #eee;margin-top:18px">
    作者 @Dreamers-seve · 洛谷: <a href="https://www.luogu.com.cn/user/668972" target="_blank" rel="noopener">https://www.luogu.com.cn/user/668972</a> · GitHub: <a href="https://github.com/seve42/OItrainer" target="_blank" rel="noopener">https://github.com/seve42/OItrainer</a>
  </footer>
</body>
</html>
