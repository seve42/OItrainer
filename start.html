<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¼€å§‹ â€” OI æ•™ç»ƒæ¨¡æ‹Ÿå™¨</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
  <header>
    <h1>OI æ•™ç»ƒæ¨¡æ‹Ÿå™¨ â€” å¼€å§‹</h1>
  </header>
  <div class="panel">
    <h3>æ–°æ¸¸æˆè®¾ç½®</h3>
    <label class="block">é€‰æ‹©éš¾åº¦</label>
    <select id="start-diff"><option value="1">ç®€å•</option><option value="2" selected>æ™®é€š</option><option value="3">å›°éš¾</option></select>

    <label class="block" style="margin-top:10px">é€‰æ‹©çœä»½</label>
    <div id="start-prov-grid" class="prov-grid"></div>

    <label class="block" style="margin-top:10px">å­¦ç”Ÿäººæ•° (3-10)</label>
    <input id="start-stu" type="number" min="3" max="10" value="5" />

    <!-- å¯¹ç‚¹æ‹›ç”ŸåŠŸèƒ½ -->
    <div class="sub-panel collapsible collapsed" id="recruit-panel">
      <h4 class="collapsible-head">ğŸ’° å¯¹ç‚¹æ‹›ç”Ÿï¼ˆÂ¥50,000 / äººï¼‰</h4>
      <div class="section-body">
        <label class="block">å­¦ç”Ÿå§“å</label>
        <input id="recruit-name" type="text" placeholder="è¾“å…¥å­¦ç”Ÿå§“å" maxlength="20" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:3px" />
      </div>
      <button class="btn" id="recruit-btn" style="font-size:14px">æ‹›ç”Ÿ</button>
      <div id="recruited-list" style="margin-top:8px;font-size:13px;color:#666"></div>
  </div>

    <!-- å­¦å‰åŸ¹å…»åŠŸèƒ½ -->
    <div class="sub-panel collapsible collapsed" id="train-panel">
      <h4 class="collapsible-head">ğŸ“š å­¦å‰åŸ¹å…»ï¼ˆÂ¥30,000 / æ¬¡ï¼‰</h4>
      <div class="section-body">
        <label class="block">é€‰æ‹©å­¦ç”Ÿ</label>
        <select id="train-student" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:3px">
          <option value="">è¯·å…ˆè¿›è¡Œå¯¹ç‚¹æ‹›ç”Ÿ</option>
        </select>
      </div>
      <div class="section-body">
        <label class="block">åŸ¹å…»æ–¹å¼</label>
        <select id="train-type" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:3px">
          <option value="random">éšæœºå±æ€§æå‡ 50%</option>
          <option value="talent">é€‰æ‹©å¤©èµ‹</option>
        </select>
      </div>
      <div id="talent-selection" style="display:none;margin-bottom:8px">
        <label class="block">é€‰æ‹©å¤©èµ‹</label>
        <!-- Hidden native select kept for backward compatibility; kept in sync with grid -->
        <select id="train-talent" style="display:none"></select>
        <div id="talent-grid" class="talent-grid"></div>
      </div>
      <button class="btn" id="train-btn" style="font-size:14px">åŸ¹å…»</button>
      <div id="training-log" style="margin-top:8px;font-size:13px;color:#666"></div>
    </div>

    <div class="modal-actions" style="margin-top:12px">
      <button class="btn btn-ghost" id="start-help">å¸®åŠ©</button>
      <button class="btn" id="start-button">å¼€å§‹æ¸¸æˆ</button>
    </div>
  </div>
</div>

<script src="events.js"></script>
<script src="lib/constants.js"></script>
<script src="lib/utils.js"></script>
<script src="lib/models.js"></script>
<script src="lib/talent.js"></script>
<script src="script.js"></script>
<script>
  // å­˜å‚¨å¯¹ç‚¹æ‹›ç”Ÿå’Œå­¦å‰åŸ¹å…»çš„å­¦ç”Ÿæ•°æ®
  let recruitedStudents = [];
  let initialBudget = 100000; // é»˜è®¤åˆå§‹é‡‘é’±

  // æ ¹æ®é€‰æ‹©çš„çœä»½å’Œéš¾åº¦æ›´æ–°åˆå§‹é‡‘é’±
  function updateInitialBudget(){
    const diff = parseInt(document.getElementById('start-diff').value);
    const provBtn = document.querySelector('#start-prov-grid .prov-btn.selected');
    const prov = provBtn ? parseInt(provBtn.dataset.val) : 1;
    const provData = PROVINCES[prov] || PROVINCES[1];
    
    let budget = provData.baseBudget;
    if(diff === 1) budget = Math.floor(budget * EASY_MODE_BUDGET_MULTIPLIER);
    else if(diff === 3) budget = Math.floor(budget * HARD_MODE_BUDGET_MULTIPLIER);
    
    initialBudget = budget;
    updateBudgetDisplay();
  }

  function updateBudgetDisplay(){
    const spent = recruitedStudents.reduce((sum, s) => sum + s.cost, 0);
    const remaining = initialBudget - spent;
    
    // æ›´æ–°æ‹›ç”ŸæŒ‰é’®çŠ¶æ€
    const recruitBtn = document.getElementById('recruit-btn');
    if(remaining < 50000){
      recruitBtn.disabled = true;
      recruitBtn.textContent = 'ç»è´¹ä¸è¶³';
    } else {
      recruitBtn.disabled = false;
      recruitBtn.textContent = 'æ‹›ç”Ÿ';
    }
    
    // æ›´æ–°åŸ¹å…»æŒ‰é’®çŠ¶æ€
    const trainBtn = document.getElementById('train-btn');
    if(remaining < 30000 || recruitedStudents.length === 0){
      trainBtn.disabled = true;
      if(recruitedStudents.length === 0) trainBtn.textContent = 'æš‚æ— å­¦ç”Ÿ';
      else trainBtn.textContent = 'ç»è´¹ä¸è¶³';
    } else {
      trainBtn.disabled = false;
      trainBtn.textContent = 'åŸ¹å…»';
    }
  }

  function updateStudentSelect(){
    const select = document.getElementById('train-student');
    select.innerHTML = '';
    
    if(recruitedStudents.length === 0){
      select.innerHTML = '<option value="">è¯·å…ˆè¿›è¡Œå¯¹ç‚¹æ‹›ç”Ÿ</option>';
    } else {
      recruitedStudents.forEach((s, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = s.name;
        select.appendChild(opt);
      });
    }
  }

  function populateTalentSelect(){
    const select = document.getElementById('train-talent');
    select.innerHTML = '';
    
    if(typeof window !== 'undefined' && window.TalentManager){
      const talents = window.TalentManager.getRegistered();
      talents.forEach(tName => {
        const info = window.TalentManager.getTalentInfo(tName);
        const opt = document.createElement('option');
        opt.value = tName;
        opt.textContent = `${tName} - ${info.description}`;
        select.appendChild(opt);
      });
    }
  }

  // å¯¹ç‚¹æ‹›ç”Ÿ
  document.getElementById('recruit-btn').onclick = function(){
    const nameInput = document.getElementById('recruit-name');
    let name = nameInput.value.trim();
    
    if(!name){
      alert('è¯·è¾“å…¥å­¦ç”Ÿå§“åï¼');
      return;
    }
    
    const spent = recruitedStudents.reduce((sum, s) => sum + s.cost, 0);
    if(initialBudget - spent < 50000){
      alert('ç»è´¹ä¸è¶³ï¼éœ€è¦ Â¥50,000');
      return;
    }
    
    // åˆ›å»ºå­¦ç”Ÿæ•°æ®
    const diff = parseInt(document.getElementById('start-diff').value);
    const provBtn = document.querySelector('#start-prov-grid .prov-btn.selected');
    const prov = provBtn ? parseInt(provBtn.dataset.val) : 1;
    const provData = PROVINCES[prov] || PROVINCES[1];
    
    let min_val, max_val;
    if(provData.type === "å¼ºçœ"){ 
      min_val = STRONG_PROVINCE_MIN_ABILITY; 
      max_val = STRONG_PROVINCE_MAX_ABILITY; 
    } else if(provData.type === "å¼±çœ"){ 
      min_val = WEAK_PROVINCE_MIN_ABILITY; 
      max_val = WEAK_PROVINCE_MAX_ABILITY; 
    } else { 
      min_val = NORMAL_PROVINCE_MIN_ABILITY; 
      max_val = NORMAL_PROVINCE_MAX_ABILITY; 
    }
    
    if(diff === 1){ 
      min_val += EASY_MODE_ABILITY_BONUS; 
      max_val += EASY_MODE_ABILITY_BONUS; 
    } else if(diff === 3){ 
      min_val -= HARD_MODE_ABILITY_PENALTY; 
      max_val -= HARD_MODE_ABILITY_PENALTY; 
    }
    
    const mean = (min_val + max_val) / 2;
    const stddev = (max_val - min_val);
    const thinking = clamp(normal(mean, stddev), 0, 100);
    const coding = clamp(normal(mean, stddev), 0, 100);
    const mental = clamp(normal(mean, stddev), 0, 100);
    
    recruitedStudents.push({
      name: name,
      thinking: thinking,
      coding: coding,
      mental: mental,
      cost: 50000,
      talents: [],
      boosts: []
    });
    
    nameInput.value = '';
    
    // æ›´æ–°æ˜¾ç¤º
    const list = document.getElementById('recruited-list');
    const item = document.createElement('div');
    item.textContent = `âœ“ ${name}ï¼ˆæ€ç»´:${thinking.toFixed(1)} ç¼–ç¨‹:${coding.toFixed(1)} å¿ƒç†:${mental.toFixed(1)}ï¼‰`;
    item.style.marginTop = '4px';
    list.appendChild(item);
    
    updateBudgetDisplay();
    updateStudentSelect();
  };

  // å­¦å‰åŸ¹å…»
  document.getElementById('train-btn').onclick = function(){
    const studentIdx = parseInt(document.getElementById('train-student').value);
    const trainType = document.getElementById('train-type').value;
    
    if(isNaN(studentIdx) || studentIdx < 0 || studentIdx >= recruitedStudents.length){
      alert('è¯·é€‰æ‹©è¦åŸ¹å…»çš„å­¦ç”Ÿï¼');
      return;
    }
    
    const spent = recruitedStudents.reduce((sum, s) => sum + s.cost, 0);
    if(initialBudget - spent < 30000){
      alert('ç»è´¹ä¸è¶³ï¼éœ€è¦ Â¥30,000');
      return;
    }
    
    const student = recruitedStudents[studentIdx];
    let logMsg = '';
    
    if(trainType === 'random'){
      // éšæœºå±æ€§æå‡ 50%
      const attrs = ['thinking', 'coding', 'mental'];
      const selectedAttr = attrs[Math.floor(Math.random() * attrs.length)];
      const attrNames = {thinking: 'æ€ç»´', coding: 'ç¼–ç¨‹', mental: 'å¿ƒç†'};
      
      const oldValue = student[selectedAttr];
      student[selectedAttr] = clamp(oldValue * 1.5, 0, 100);
      student.cost += 30000;
      student.boosts.push({type: 'attr', attr: selectedAttr, value: 1.5});
      
      logMsg = `${student.name} - ${attrNames[selectedAttr]}å±æ€§æå‡ 50%ï¼ˆ${oldValue.toFixed(1)} â†’ ${student[selectedAttr].toFixed(1)}ï¼‰`;
    } else {
      // é€‰æ‹©å¤©èµ‹
      const talentName = document.getElementById('train-talent').value;
      if(!talentName){
        alert('è¯·é€‰æ‹©å¤©èµ‹ï¼');
        return;
      }
      
      if(student.talents.includes(talentName)){
        alert('è¯¥å­¦ç”Ÿå·²æ‹¥æœ‰æ­¤å¤©èµ‹ï¼');
        return;
      }
      
      student.talents.push(talentName);
      student.cost += 30000;
      student.boosts.push({type: 'talent', name: talentName});
      
      logMsg = `${student.name} - è·å¾—å¤©èµ‹ã€Œ${talentName}ã€`;
    }
    
    // æ›´æ–°æ˜¾ç¤º
    const log = document.getElementById('training-log');
    const item = document.createElement('div');
    item.textContent = `âœ“ ${logMsg}`;
    item.style.marginTop = '4px';
    log.appendChild(item);
    
    updateBudgetDisplay();
  };

  // ç›‘å¬åŸ¹å…»æ–¹å¼å˜åŒ–
  document.getElementById('train-type').onchange = function(){
    const talentDiv = document.getElementById('talent-selection');
    if(this.value === 'talent'){
      talentDiv.style.display = 'block';
      populateTalentSelect();
    } else {
      talentDiv.style.display = 'none';
    }
  };

  // æ¸²æŸ“å¤©èµ‹ä¸ºå¹³é“ºå¡ç‰‡å¹¶åŒæ­¥åˆ°éšè—çš„ selectï¼ˆå‘åå…¼å®¹ï¼‰
  function renderTalentGrid(){
    const grid = document.getElementById('talent-grid');
    const hiddenSelect = document.getElementById('train-talent');
    grid.innerHTML = '';
    hiddenSelect.innerHTML = '';
    if(typeof window === 'undefined' || !window.TalentManager) return;
    const talents = window.TalentManager.getRegistered();
    talents.forEach(name => {
      const info = window.TalentManager.getTalentInfo(name) || {};
      // populate hidden select
      const opt = document.createElement('option'); opt.value = name; opt.textContent = name; hiddenSelect.appendChild(opt);

      // create card
      const card = document.createElement('div'); card.className = 'talent-card'; card.dataset.val = name;
      const top = document.createElement('div');
      const dot = document.createElement('span'); dot.className = 'color-dot'; dot.style.background = (info.color || '#2b6cb0');
      const title = document.createElement('span'); title.className = 'title'; title.textContent = name;
      top.appendChild(dot); top.appendChild(title);
      const desc = document.createElement('div'); desc.className = 'desc'; desc.textContent = info.description || '';
      card.appendChild(top); card.appendChild(desc);

      card.addEventListener('click', ()=>{
        // toggle selection (single select)
        grid.querySelectorAll('.talent-card.selected').forEach(c=>c.classList.remove('selected'));
        card.classList.add('selected');
        hiddenSelect.value = name;
      });

      grid.appendChild(card);
    });
  }

  // Keep populateTalentSelect compatible: populate hidden select and grid
  const _oldPopulate = populateTalentSelect;
  populateTalentSelect = function(){
    _oldPopulate && _oldPopulate();
    renderTalentGrid();
  };

  // initial render if talent mode is visible
  setTimeout(()=>{
    if(document.getElementById('train-type').value === 'talent') renderTalentGrid();
  }, 120);

  // ç›‘å¬éš¾åº¦å’Œçœä»½å˜åŒ–
  document.getElementById('start-diff').onchange = updateInitialBudget;

  // render province buttons using PROVINCES from script.js
  if(typeof PROVINCES !== 'undefined'){
    renderStartPageUI && renderStartPageUI();
    // ç»™çœä»½æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
    setTimeout(() => {
      document.querySelectorAll('#start-prov-grid .prov-btn').forEach(btn => {
        btn.addEventListener('click', updateInitialBudget);
      });
      updateInitialBudget();
    }, 100);
  }
  
  document.getElementById('start-button').onclick = ()=>{ 
    // å°†æ‹›ç”Ÿæ•°æ®ä¿å­˜åˆ° sessionStorage
    if(recruitedStudents.length > 0){
      sessionStorage.setItem('oi_recruited_students', JSON.stringify(recruitedStudents));
    } else {
      sessionStorage.removeItem('oi_recruited_students');
    }
    startFromStartPage && startFromStartPage(); 
  };
  
  document.getElementById('start-help').onclick = ()=>{ window.open('help.html','_blank'); };

  // åˆå§‹åŒ–å¯æŠ˜å é¢æ¿ï¼šé»˜è®¤æŠ˜å å¯¹ç‚¹æ‹›ç”Ÿä¸å­¦å‰åŸ¹å…»ï¼Œç‚¹å‡»æ ‡é¢˜åˆ‡æ¢
  (function(){
    function togglePanel(panel, expand){
      if(expand){
        panel.classList.remove('collapsed');
        panel.classList.add('expanded');
      } else {
        panel.classList.remove('expanded');
        panel.classList.add('collapsed');
      }
    }

    document.querySelectorAll('.sub-panel.collapsible').forEach(panel => {
      const head = panel.querySelector('.collapsible-head');
      // ensure initial state: keep collapsed if class present
      if(panel.classList.contains('collapsed')){
        togglePanel(panel, false);
      } else {
        togglePanel(panel, true);
      }

      head && head.addEventListener('click', ()=>{
        const isCollapsed = panel.classList.contains('collapsed');
        togglePanel(panel, isCollapsed);

        // If expanding the train panel, ensure talent grid/select are populated when needed
        if(panel.id === 'train-panel' && !isCollapsed){
          const type = document.getElementById('train-type').value;
          if(type === 'talent') renderTalentGrid();
          populateTalentSelect();
        }
      });
    });
  })();
</script>
  <footer style="text-align:center;padding:12px 8px;color:#666;font-size:13px;border-top:1px solid #eee;margin-top:18px">
    ä½œè€… @Dreamers-seve Â· æ´›è°·: <a href="https://www.luogu.com.cn/user/668972" target="_blank" rel="noopener">https://www.luogu.com.cn/user/668972</a> Â· GitHub: <a href="https://github.com/Dreamersseve/OItrainer" target="_blank" rel="noopener">https://github.com/Dreamersseve/OItrainer</a>
  </footer>
</body>
</html>
